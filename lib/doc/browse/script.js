/*
  GF RGL Browser
  John J. Camilleri, 2012
*/
$(document).ready(function() {

    var loadCount = 0;
    var showLoading = function(){
        loadCount++;
        $("#loading").show();
    }
    var hideLoading = function(){
        loadCount = Math.max(loadCount-1, 0);
        if (loadCount == 0)
            $("#loading").hide();
    }

    var scrollToTop = function() {
        $("html, body").animate({ scrollTop: 0 }, "slow");
    }
    var scrollToCodeLine = function(lineNo) {
        showPanel("#code", function() {
            // Find exact line, using the classes generated by google prettify
            var obj = $("#code pre li.L"+(lineNo%10)+":eq("+Math.floor(lineNo/10)+")").prev();
            var y = Math.max(obj.offset().top - obj.parent().offset().top - 75, 0);
            $("#code pre").animate({ scrollTop: y }, "slow", function(){
                highlight(obj);
            });
        });
    }
    var highlight = function(obj) {
        obj.css('background-color', "yellow");
        setTimeout(function(){
            obj.css('background-color', "");
        }, 1500);
    }

    var clearScope = function(msg) {
        $('#scope_list').empty();
        updateScopeCount();
        if (msg) {
            $('#scope_list').html("<em>"+msg+"</em>");
        }
    }
    var setScope = function(code) {
        $('#scope_list').html(code);
    }
    var clearCode = function(msg) {
        $('#code pre').empty();
        if (msg) {
            $('#codes pre').html("<em>"+msg+"</em>");
        }
    }
    var setCode = function(code) {
        $('#code pre').html(code);
        prettyPrint();
    }

    var current_language = undefined;
    var urlPrefix = "/";
    var index;
    $.ajax({
        url: "index.json",
        dataType: "json",
        type: "GET",
        success: function(data) {
            index = data;
            if (data['urlprefix']) urlPrefix = data['urlprefix'];

            // Initialize the language list
            var lang_select = $("<select>")
                .attr('id', 'language_select')
                .change(function(){
                    setLanguage($(this).val());
                })
                .appendTo("#languages")
            var language_list = data['languages'];
            for (i in language_list) {
                if (!i) continue;
                var lang = i;
                $('<option>')
                    .html(lang)
                    .appendTo(lang_select);
            }
            setLanguage("english");
            hideLoading();
        },
        error: function(){
            hideLoading();
            alert("Error getting index. Try reloading page, or just give up.");
        }
    });

    var setLanguage = function(lang){
        current_language = lang;
        $("#languages select").val(lang);
        initModules(lang);
    }

    // Initialize the module list
    var initModules = function(lang){
        index['languages'][lang] = index['languages'][lang].sort();
        $("#modules").empty();
        for (i in index['languages'][lang]) {
            var module = index['languages'][lang][i];
            if (!module) continue;
            $('<a>')
                .html(module)
                .addClass('button')
                .attr('href', "#"+lang+"/"+module+".gf")
                .appendTo("#modules");
        }
    };

    // Initialize the panels & tabs
    // obj can be just a plain selector or a jQuery object
    var showPanel = function(obj, callback){
        showLoading();
        setTimeout(function(){
            $(".panel:visible").hide();
            $(obj).show(0, callback);
            recalculateHeights();
            hideLoading();
        }, 500); // this ensures the loading displays
    }
    var getPanel = function() {
        return $('.panel:visible').first();
    }
    $(".panel").each(function(a,b){
        $("<a>")
            .addClass('tab')
            .addClass($(b).attr('id'))
            .attr('href', '#'+$(b).attr('id'))
            .html($(b).attr('id'))
            .click(function(){
                showPanel(b);
                return false;
            })
//            .appendTo("#tabbar")
            .insertBefore("#tabbar *:last-child")
   });
    showPanel(".panel:first");

    var setTitle = function(s){
        $('#tabbar h2').html(s);
    }

    var updateScopeCount = function(){
        $('#scope_count').text( $("#scope_list tr:visible").length );
    }

    // Load both scope & source for a file
    var loadFile = function(lang, module, lineNo){
        setTitle(lang+"/"+module);
        loadTagsFile(module);
        loadSourceFile(lang, module, lineNo)
    }

    // Load a tags file
    var loadTagsFile = function(module) {
        clearScope();
        showLoading();
        $.ajax({
            url: "tags/"+module+".gf-tags",
            type: "GET",
            dataType: "text",
            success: function(data){
                data = data.replace(/^(\S+)\s(\S+)\s(.+)?$/gm, function(a,b,c,d){
                    var s = d.split("\t");
                    if (c == "indir") {
                        var name = s[2].slice(s[2].lastIndexOf('/')+1);
                        var url = "#"+name;
                        var anchor = '<a href="'+url+'">'+name+'</a>';
                        return '<tr class="indir" name="'+b+'"><th>'+b+'</th><td>'+c+'</td><td>'+s[0]+'</td><td>'+s[1]+'</td><td>'+anchor+'</td><td></td></tr>'
                    } else {
                        var bits = s[0].split("/"); // ["lib", "src", "english", "AdjectiveEng.gf:43-46"]
                        var url = "#"+bits[3]+"/"+bits[4];
                        var anchor = '<a href="'+url+'">'+s[0]+'</a>';
                        return '<tr class="local" name="'+b+'"><th>'+b+'</th><td>'+c+'</td><td></td><td></td><td>'+anchor+'</td><td>'+s[1]+'</td></tr>'
                    }
                });
                setScope(data);
                updateScopeCount();
                runFilter();
                hideLoading();
            },
            error: function(data){
                clearScope("No scope available");
                hideLoading();
            },
        });
    }

    // Just get the HTTP headers to see if a file exists
    var checkSourceFile = function(args) {
        $.ajax({
            url: urlPrefix + "lib/src/"+args.lang+"/"+args.module+".gf",
            type: "HEAD",
            success: args.onsuccess,
            error: args.onerror
        });    
    }

    // Load a source module
    var loadSourceFile = function(lang, module, lineNo) {
        clearCode();
        showLoading();
        $.ajax({
            url: urlPrefix + "lib/src/"+lang+"/"+module+".gf",
            type: "GET",
            dataType: "text",
            success: function(data, status, xhr){
                setCode(data);
                hideLoading();
                if (lineNo) {
                    scrollToCodeLine(lineNo);
                }
            },
            error: function(data){
                clearCode("No code available");
                hideLoading();
            }
        });
    }

    // Custom selector
    $.expr[':'].match = function(a,b,c) {
        var obj = $(a);
        var needle = c[3];
        var haystack = obj.attr('name');
        if (haystack == undefined)
            return false;
        if ($("#case_sensitive").is(":checked"))
            return haystack.indexOf(needle)>=0;
        else
            return haystack.toLowerCase().indexOf(needle.toLowerCase())>=0;
    };

    var runFilter = function() {
        showLoading()
        var s = $("#search").val();
        try {
            if (s) {
                $("#scope_list tr:match(\""+s+"\")").show();
                $("#scope_list tr:not(:match(\""+s+"\"))").hide();
            } else {
                $("#scope_list tr").show();
            }
            if ($("#show_local").is(":checked") ) {
                $("#scope_list tr.indir").hide();
            }
        } catch (error) {
            alert(error.message);
        }
        updateScopeCount();
        hideLoading();
    }

    // Instant results
    var prevSearch = $("#search").val();
    $("#search").keyup(function(){
        var s = $("#search").val();
        if (s!=prevSearch) {
            runFilter();
            prevSearch = s;
        }
    });
    $("#submit").hide();

    // Filter & clear buttons
    // $("#submit").click(runFilter);

    $("#search").keypress(function(e){
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code == 13) { // Enter
            runFilter();
        }        
    });
    $("#clear").click(function(){
        $("#search")
            .val('')
            .focus()
        runFilter();
    });
    $("#case_sensitive").change(runFilter);
    $("#show_all").change(runFilter);
    $("#show_local").change(runFilter);

    // ===== URL history =====
    $.History.bind(function(state){
        var s = state.split("/");
        if (s[0].match(/\.gf-tags$/)) {
            var module = stripExt(s[0]);
            checkSourceFile({
                lang: current_language,
                module: module,
                onsuccess: function(){
                    $.History.go(current_language+"/"+module);
                },
                onerror: function(){
                    // Load just tags (we don't know source)
                    setTitle(module+" (scope only)");
                    clearCode();
                    loadTagsFile(module);
                    scrollToTop();
                }
            });
        } else {
            var lang = s[0];
            var module = stripExt(s[1]);
            var parseLineNo = s[1].match(/:(\d+)(-(\d+))?$/);
            if (parseLineNo != undefined)
                loadFile(lang, module, parseInt(parseLineNo[1]));
            else
                loadFile(lang, module);
        }
    });

    var stripExt = function(s) {
        return s.substr(0, s.lastIndexOf('.'));
    };

    // ===== Resizing stuff =====

    // refer: http://paulirish.com/2009/throttled-smartresize-jquery-event-handler/
    (function($,sr){
        // debouncing function from John Hann
        // http://unscriptable.com/index.php/2009/03/20/debouncing-javascript-methods/
        var debounce = function (func, threshold, execAsap) {
            var timeout;
            return function debounced () {
                var obj = this, args = arguments;
                function delayed () {
                    if (!execAsap)
                        func.apply(obj, args);
                    timeout = null; 
                };
                
                if (timeout)
                    clearTimeout(timeout);
                else if (execAsap)
                    func.apply(obj, args);
                
                timeout = setTimeout(delayed, threshold || 100); 
            };
        }
	// smartresize 
	jQuery.fn[sr] = function(fn){  return fn ? this.bind('resize', debounce(fn)) : this.trigger(sr); };
    })(jQuery,'smartresize');
    
    // usage:
    $(window).smartresize(function() {
        recalculateHeights();
    });

    var recalculateHeights = function() {
        $('body').height( $(window).height()-85); //80 was just found empirically
        $('.maxheight').each(function(){
            var obj = $(this);
            var parent = obj.parent();
            obj.height(parent.height() - (obj.offset().top - parent.offset().top) - parseInt(parent.css('padding-bottom')));
        });
    }

    recalculateHeights();
});
