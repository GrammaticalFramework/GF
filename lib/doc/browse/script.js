/*
  GF RGL Browser
  John J. Camilleri, 2012
*/

var thing = null;
$(document).ready(function(){

    thing = new Thing();

    // ===== URL history =====
    $.history.on('load change push pushed', function(event, url, type) {
        var stripExt = function(s) {
            var i = s.lastIndexOf('.');
            return (i>-1) ? s.substr(0, i) : s;
        };

        var s = url.split("/");
        var lang = s[0];
        var module = stripExt(s[1]);
        var parseLineNo = s[1].match(/:(\d+)(-(\d+))?$/);

        if (thing.state.current.equals(lang, module)) {
            if (parseLineNo) {
                scrollToCodeLine(parseInt(parseLineNo[1]));
            }
            // else there's nothing to do!
        } else {
            if (parseLineNo != null)
                thing.loadFile(lang, module, parseInt(parseLineNo[1]));
            else
                thing.loadFile(lang, module);
        }
    }).listen('hash');
});

function Thing() {
    var t = this;

    // ===== State information =====

    this.state = {
        index: undefined,
        lookup: {},
        loadCount: 0,
        language: undefined, // lang of drop-down
        current: { // current file
            language: undefined,
            module: undefined,
            set: function(lang, module) {
                t.state.current.language = lang;
                t.state.current.module = module;
            },
            equals: function(a, b) {
                if (!b)
                    return (a == t.state.current.module);
                else
                    return (a == t.state.current.language) && (b == t.state.current.module);
            }
        },
        title: "RGL Source Browser",
        urlPrefix: "/",
        defaultLangs: ['abstract','api','common','prelude']
    } ;

    var lookupModuleLanguage = function(module) {
        var l = t.state.lookup[module];
        if (l==undefined || l.length==0)
            return null;
        else if (l.length==1)
            return l[0];
        else {
            for (i in l) {
                if ($.inArray(l[i], t.state.defaultLangs))
                    return l[i];
            }
            return l[0]; // no preferred default, just return first...
        }
    }
    var lookupAllModuleLanguages = function(module) {
        return t.state.lookup[module];
    }

    // ===== Utility/UI functions =====

    var showLoading = function(){
        t.state.loadCount++;
        $("#loading").show();
    }
    var hideLoading = function(){
        t.state.loadCount = Math.max(t.state.loadCount-1, 0);
        if (t.state.loadCount == 0)
            $("#loading").hide();
    }

    var scrollToTop = function() {
        $("html, body").animate({ scrollTop: 0 }, "slow");
    }
    var scrollToCodeLine = function(lineNo) {
        showPanel("#code", function() {
            // Find exact line, using the classes generated by google prettify
            var obj = $("#code pre li.L"+(lineNo%10)+":eq("+Math.floor(lineNo/10)+")").prev();
            var y = Math.max(obj.offset().top - obj.parent().offset().top - 75, 0);
            $("#code pre").animate({ scrollTop: y }, "slow", function(){
                highlight(obj);
            });
        });
    }
    var highlight = function(obj) {
        obj.css('background-color', "yellow");
        setTimeout(function(){
            obj.css('background-color', "");
        }, 1500);
    }

    var clearScope = function(msg) {
        $('#scope #results').empty();
        updateScopeCount();
        if (msg) {
            $('#scope #results').html("<em>"+msg+"</em>");
        }
    }
    var setScope = function(code) {
        $('#scope #results').html(code);
    }
    var clearCode = function(msg) {
        $('#code pre').empty();
        if (msg) {
            $('#codes pre').html("<em>"+msg+"</em>");
        }
    }
    var setCode = function(code) {
        $('#code pre').text(code);
        prettyPrint();
    }
    var updateScopeCount = function(){
        $('#scope #count').text( $("#scope #results tr:visible").length );
    }
    var updateAPICount = function(){
        $('#api #count').text( $("#api #results tr:visible").length );
    }

    var setLanguage = function(lang){
        t.state.language = lang;
        $("#languages select").val(lang);
        initModules(lang);
    }

    // obj can be just a plain selector or a jQuery object
    this.showPanel = function(obj, callback){
        showLoading();
        setTimeout(function(){
            $(".panel:visible").hide();
            $(obj).show(0, callback);
            updateScopeCount();
            hideLoading();
        }, 500); // this ensures the loading displays
    }
    var getPanel = function() {
        return $('.panel:visible').first();
    }

    var setTitle = function(s){
        $('#module_name').html(s);
        $('title').html(t.state.title + ": " + s);
    }


    // ===== Initialization =====

    // Initialize the panels, tabs
    $("a.tab").click(function(){
        var panel = $(this).attr("href");
        t.showPanel(panel);
        return false;
    });
    t.showPanel(".panel:first");

    // Load the index file and populate language & module lists
    $.ajax({
        url: "index.json",
        dataType: "json",
        type: "GET",
        success: function(data) {
            t.state.index = data;
            if (data['urlprefix']) t.state.urlPrefix = data['urlprefix'];

            // Build language lookup index
            for (var lang in data['languages']) {
                for (var i in data['languages'][lang]) {
                    var module = data['languages'][lang][i];
                    if (!module) continue;
                    if (!t.state.lookup[module]) t.state.lookup[module] = [];
                    t.state.lookup[module].push(lang);
                }
            }

            // Initialize the language list
            var lang_select = $("<select>")
                .attr('id', 'language_select')
                .change(function(){
                    setLanguage($(this).val());
                })
                .appendTo("#languages")
            var language_list = data['languages'];
            for (var i in language_list) {
                if (!i) continue;
                var lang = i;
                $('<option>')
                    .html(lang)
                    .appendTo(lang_select);
            }
            setLanguage("english");

            // Initialize API results
            initAPI();

            // Done
            hideLoading();
        },
        error: function(){
            hideLoading();
            alert("Error getting index. Try reloading page, or just give up.");
        }
    });


    // ===== Loading functionality =====

    // Initialize the module list
    var initModules = function(lang){
        t.state.index['languages'][lang] = t.state.index['languages'][lang].sort();
        $("#modules").empty();
        for (var i in t.state.index['languages'][lang]) {
            var module = t.state.index['languages'][lang][i];
            if (!module) continue;
            $('<a>')
                .html(module)
                .attr('href', "#"+lang+"/"+module+".gf")
                .appendTo("#modules");
        }
    };

    // Load both scope & source for a file
    this.loadFile = function(lang, module, lineNo){
        setTitle(lang+"/"+module);
        t.state.current.set(lang, module);
        loadTagsFile(module);
        loadSourceFile(lang, module, lineNo);
    }

    // Load a tags file
    var loadTagsFile = function(module) {
        clearScope();
        showLoading();
        $.ajax({
            url: "tags/"+module+".gf-tags",
            type: "GET",
            dataType: "text",
            success: function(data){
                data = data.replace(/^(\S+)\s(\S+)\s(.+)?$/gm, function(a,b,c,d){
                    var s = d.split("\t");
                    if (c == "indir") {
                        var module = s[2].substring(s[2].lastIndexOf('/')+1, s[2].lastIndexOf('.'));
                        var lang = lookupModuleLanguage(module);
                        var name =    lang+"/"+module;
                        var url = "#"+lang+"/"+module;
                        var anchor = '<a href="'+url+'">'+name+'</a>';
                        return '<tr class="indir" name="'+b+'"><th>'+b+'</th><td>'+c+'</td><td>'+s[0]+'</td><td>'+s[1]+'</td><td>'+anchor+'</td><td></td></tr>'
                    } else {
                        var bits = s[0].split("/"); // ["lib", "src", "english", "AdjectiveEng.gf:43-46"]
                        var name =    bits[3]+"/"+bits[4];
                        var url = "#"+bits[3]+"/"+bits[4];
                        var anchor = '<a href="'+url+'">'+name+'</a>';
                        return '<tr class="local" name="'+b+'"><th>'+b+'</th><td>'+c+'</td><td></td><td></td><td>'+anchor+'</td><td>'+s[1]+'</td></tr>'
                    }
                });
                setScope(data);
                runFilter();
                hideLoading();
            },
            error: function(data){
                clearScope("No scope available");
                hideLoading();
            },
        });
    }

    // Load a source module
    var loadSourceFile = function(lang, module, lineNo) {
        clearCode();
        showLoading();
        $.ajax({
            url: t.state.urlPrefix + "lib/src/"+lang+"/"+module+".gf",
            type: "GET",
            dataType: "text",
            success: function(data, status, xhr){
                setCode(data);
                hideLoading();
                if (lineNo) {
                    scrollToCodeLine(lineNo);
                }
            },
            error: function(data){
                clearCode("No code available");
                hideLoading();
            }
        });
    }

    // Which modules do we include for API?
    var apiModules = [
        // api
        "Constructors",
        // abstract
        "Adjective",
        "Adverb",
        "Backward",
        "Cat",
        "Common",
        "Compatibility",
        "Conjunction",
        "Extra",
        "Grammar",
        "Idiom",
        "Lang",
        "Lexicon",
        "Noun",
        "Numeral",
        "NumeralTransfer",
        "Phrase",
        "Question",
        "Relative",
        "Sentence",
        "Structural",
        "Symbol",
        "Tense",
        "Text",
        "Transfer",
        "Verb",
    ];
    var initAPI = function() {
        showLoading();
        $('#api #results').empty();
        for (var i in apiModules) {
            var module = apiModules[i];
            $.ajax({
                url: "tags/"+module+".gf-tags",
                type: "GET",
                dataType: "text",
                success: function(data){
                    data = data.replace(/^(\S+)\s(\S+)\s(.+)?$/gm, function(a,b,c,d){
                        var out = '';
                        var s = d.split("\t");
                        if (c != "indir") {
                            var type = s[1];
                            if (type) {
                                var bits = s[0].split("/"); // ["lib", "src", "english", "AdjectiveEng.gf:43-46"]
                                var name = bits[3]+"/"+bits[4];
                                var url = "#"+bits[3]+"/"+bits[4];
                                var anchor = '<a href="'+url+'">'+name+'</a>';
                                out += '<tr name="'+b+'"><th>'+b+'</th><td>'+c+'</td><td>'+anchor+'</td><td>'+s[1]+'</td></tr>'
                            }
                        }
                        return out;
                    });
                    $('#api #results').append($(data));
                    $("#api #results tr").removeClass('odd');
                    $("#api #results tr:odd").addClass('odd');
                },
                error: function(data){
                    console.log("Error loading tags file: " + module);
                },
            });
        }
        hideLoading();
    }


    // ===== Filtering of scope info =====

    // Custom selector
    $.expr[':'].match = function(a,b,c) {
        var obj = $(a);
        var needle = c[3];
        var haystack = obj.attr('name');
        if (haystack == undefined)
            return false;
        if ($("#scope #case_sensitive").is(":checked"))
            return haystack.indexOf(needle)>=0;
        else
            return haystack.toLowerCase().indexOf(needle.toLowerCase())>=0;
    };

    var runFilter = function() {
        showLoading();
        $("#scope #results tr").removeClass('odd');
        var s = $("#scope #search").val();
        try {
            if (s) {
                $("#scope #results tr").hide();
                $("#scope #results tr:match(\""+s+"\")").show();
            } else {
                $("#scope #results tr").show();
            }
            if ($("#scope #show_local").is(":checked") ) {
                $("#scope #results tr.indir").hide();
            }
        } catch (error) {
            alert(error.message);
        }
        updateScopeCount();
        $("#scope #results tr:visible:odd").addClass('odd');
        hideLoading();
    }

    // Instant results
    var prevSearch = $("#scope #search").val();
    $("#scope #search").keyup(function(){
        var s = $("#scope #search").val();
        if (s!=prevSearch) {
            runFilter();
            prevSearch = s;
        }
    });

    $("#scope #search").keypress(function(e){
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code == 13) { // Enter
            runFilter();
        }
    });
    $("#scope #clear").click(function(){
        $("#scope #search")
            .val('')
            .focus()
        runFilter();
    });
    $("#scope #case_sensitive").change(runFilter);
    $("#scope #show_all").change(runFilter);
    $("#scope #show_local").change(runFilter);

    // ===== API search =====

    // Custom selector
    $.expr[':'].matchAPI = function(a,b,c) {
        var obj = $(a); // tr
        var ident = $(obj.children().get(0)).text();
        var type  = $(obj.children().get(3)).text();
        var needle = c[3];
        var match_ident = ident.toLowerCase().indexOf(needle.toLowerCase())>=0;
        var match_type  =  type.toLowerCase().indexOf(needle.toLowerCase())>=0;
        // if ($("#scope #case_sensitive").is(":checked"))
        //     return haystack.indexOf(needle)>=0;
        // else
            return match_ident || match_type ;
    };

    var runFilterAPI = function() {
        showLoading();
        $("#api #results tr").removeClass('odd');
        var s = $("#api #search").val();
        try {
            if (s) {
                $("#api #results tr").hide();
                $("#api #results tr:matchAPI(\""+s+"\")").show();
            } else {
                $("#api #results tr").show();
            }
        } catch (error) {
            alert(error.message);
        }
        updateAPICount();
        $("#api #results tr:visible:odd").addClass('odd');
        hideLoading();
    }

    // Instant results
    var prevAPISearch = $("#api #search").val();
    $("#api #search").keyup(function(){
        var s = $("#api #search").val();
        if (s!=prevAPISearch) {
            runFilterAPI();
            prevAPISearch = s;
        }
    });

    $("#api #search").keypress(function(e){
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code == 13) { // Enter
            runFilterAPI();
        }
    });
    $("#api #clear").click(function(){
        $("#api #search")
            .val('')
            .focus()
        runFilterAPI();
    });
};
